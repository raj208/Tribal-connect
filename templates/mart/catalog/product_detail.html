{% extends "base.html" %}
{% block title %}{{ product.title }} | Tribal Mart{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-lg-6">
    {% if product.main_image %}
    <img src="{{ product.main_image.url }}" class="img-fluid rounded mb-3" alt="main">
    {% endif %}

    <div class="row g-2">
      {% for img in product.images.all %}
      <div class="col-4">
        <img src="{{ img.image.url }}" class="img-fluid rounded" alt="extra">
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="col-lg-6">
    <h2 class="mb-1">{{ product.title }}</h2>
    <div class="text-muted">
      by <a href="{% url 'artisans:detail' product.artisan.user.username %}">
        {{ product.artisan.display_name|default:product.artisan.user.username }}
      </a>
    </div>

    <div class="mt-2 fs-4">₹{{ product.price }}</div>

    <div class="mt-2 small">
      ⭐ {{ product.rating_avg|floatformat:1 }} ({{ product.rating_count }})
    </div>

    {% if can_review %}
      <div class="mt-2">
        <a class="btn btn-outline-dark btn-sm" href="{% url 'reviews:review_product' product.id %}">
          Write / Edit Review
        </a>
      </div>
    {% endif %}


    {% if product.is_made_to_order %}
    <div class="small text-muted">Made-to-order • Usually ships in {{ product.production_time_days }} days</div>
    {% endif %}

    {% if product.category %}
    <div class="mt-2"><span class="badge bg-secondary">{{ product.category.name }}</span></div>
    {% endif %}

    <hr>

    <p style="white-space: pre-line">{{ product.description }}</p>
    
    <hr>
    <h5>Reviews</h5>

    {% for r in reviews %}
      <div class="card p-3 mb-2">
        <div class="d-flex justify-content-between">
          <div class="fw-semibold">{{ r.user.username }}</div>
          <div>⭐ {{ r.rating }}/5</div>
        </div>
        {% if r.comment %}
          <div class="mt-2" style="white-space: pre-line">{{ r.comment }}</div>
        {% endif %}
        <div class="small text-muted mt-2">{{ r.created_at }}</div>
      </div>
    {% empty %}
      <p class="text-muted">No reviews yet.</p>
    {% endfor %}


    <div class="mt-4">
      <form method="post" action="{% url 'cart:add' product.pk %}" class="d-flex gap-2 align-items-center">
        {% csrf_token %}
        <input type="number" name="qty" value="1" min="1" class="form-control" style="max-width: 110px;">
        <button class="btn btn-dark" type="submit">Add to Cart</button>
      </form>
    </div>

  </div>
</div>
{% endblock %}